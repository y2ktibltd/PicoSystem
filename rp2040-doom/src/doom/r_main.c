//
// Copyright(C) 1993-1996 Id Software, Inc.
// Copyright(C) 2005-2014 Simon Howard
// Copyright(C) 2021-2022 Graham Sanderson
//
// This program is free software; you can redistribute it and/or
// modify it under the terms of the GNU General Public License
// as published by the Free Software Foundation; either version 2
// of the License, or (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// DESCRIPTION:
//	Rendering main loop and setup functions,
//	 utility functions (BSP, geometry, trigonometry).
//	See tables.c, too.
//





#include <stdlib.h>
#include <math.h>


#include "doomdef.h"
#include "d_loop.h"

#include "m_bbox.h"
#include "m_menu.h"

#include "r_local.h"
#include "r_sky.h"

#if PICO_DOOM
#include "picodoom.h"
#if PICO_BUILD
#include "hardware/gpio.h"
#endif
#endif
#if USE_WHD
#include "p_spec.h"
#endif
// Fineangles in the SCREENWIDTH wide window.
#define FIELDOFVIEW        2048
#if MU_STATS
uint32_t stats_dc_iscale_min, stats_dc_iscale_max;
#endif


int viewangleoffset;

// increment every time a check is made
#if !USE_WHD
int validcount = 1;
#else
int8_t validcount = 1;
#endif


#if !USE_LIGHTMAP_INDEXES
extern const lighttable_t**	walllights;
const lighttable_t*		fixedcolormap;
#else
extern int8_t *walllights;
int8_t fixedcolormap;
#endif

int centerx;
int centery;

fixed_t centerxfrac;
fixed_t centeryfrac;
fixed_t projection;

// just for profiling purposes
int framecount;

//int sscount;
int linecount;
//int loopcount;

fixed_t viewx;
fixed_t viewy;
fixed_t viewz;

angle_t viewangle;

fixed_t viewcos;
fixed_t viewsin;

player_t *viewplayer;

// 0 = high, 1 = low
int detailshift;

//
// precalculated math tables
//

angle_t clipangle;
#if !FIXED_SCREENWIDTH
// The viewangletox[viewangle + FINEANGLES/4] lookup
// maps the visible view angles to screen X coordinates,
// flattening the arc to a flat projection plane.
// There will be many angles mapped to the same X.
isb_int16_t viewangletox[FINEANGLES / 2];

// The xtoviewangleangle[] table maps a screen pixel
// to the lowest viewangle that maps back to x ranges
// from clipangle to -clipangle.
angle_t xtoviewangle[SCREENWIDTH + 1];
#else
const uint16_t xtoviewangle_[SCREENWIDTH + 1] = {
        0x2008, 0x1fe0, 0x1fc0, 0x1fa0, 0x1f80, 0x1f60, 0x1f40, 0x1f18, 0x1ef8, 0x1ed8, 0x1eb0, 0x1e90, 0x1e70, 0x1e48, 0x1e28, 0x1e00,
        0x1de0, 0x1db8, 0x1d98, 0x1d70, 0x1d50, 0x1d28, 0x1d00, 0x1ce0, 0x1cb8, 0x1c90, 0x1c68, 0x1c48, 0x1c20, 0x1bf8, 0x1bd0, 0x1ba8,
        0x1b80, 0x1b58, 0x1b30, 0x1b08, 0x1ae0, 0x1ab8, 0x1a90, 0x1a68, 0x1a38, 0x1a10, 0x19e8, 0x19c0, 0x1990, 0x1968, 0x1940, 0x1910,
        0x18e8, 0x18b8, 0x1890, 0x1860, 0x1838, 0x1808, 0x17d8, 0x17b0, 0x1780, 0x1750, 0x1720, 0x16f8, 0x16c8, 0x1698, 0x1668, 0x1638,
        0x1608, 0x15d8, 0x15a8, 0x1578, 0x1548, 0x1518, 0x14e0, 0x14b0, 0x1480, 0x1450, 0x1418, 0x13e8, 0x13b8, 0x1380, 0x1350, 0x1318,
        0x12e8, 0x12b0, 0x1280, 0x1248, 0x1218, 0x11e0, 0x11a8, 0x1170, 0x1140, 0x1108, 0x10d0, 0x1098, 0x1060, 0x1028, 0x0ff0, 0x0fb8,
        0x0f80, 0x0f48, 0x0f10, 0x0ed8, 0x0ea0, 0x0e68, 0x0e30, 0x0df8, 0x0db8, 0x0d80, 0x0d48, 0x0d08, 0x0cd0, 0x0c98, 0x0c58, 0x0c20,
        0x0be0, 0x0ba8, 0x0b68, 0x0b30, 0x0af0, 0x0ab8, 0x0a78, 0x0a38, 0x0a00, 0x09c0, 0x0980, 0x0948, 0x0908, 0x08c8, 0x0888, 0x0848,
        0x0810, 0x07d0, 0x0790, 0x0750, 0x0710, 0x06d0, 0x0690, 0x0650, 0x0610, 0x05d0, 0x0590, 0x0550, 0x0510, 0x04d0, 0x0490, 0x0450,
        0x0410, 0x03d0, 0x0390, 0x0350, 0x0310, 0x02d0, 0x0288, 0x0248, 0x0208, 0x01c8, 0x0188, 0x0148, 0x0108, 0x00c0, 0x0080, 0x0040,
        0x0000, 0xffc0, 0xff80, 0xff40, 0xfef8, 0xfeb8, 0xfe78, 0xfe38, 0xfdf8, 0xfdb8, 0xfd78, 0xfd30, 0xfcf0, 0xfcb0, 0xfc70, 0xfc30,
        0xfbf0, 0xfbb0, 0xfb70, 0xfb30, 0xfaf0, 0xfab0, 0xfa70, 0xfa30, 0xf9f0, 0xf9b0, 0xf970, 0xf930, 0xf8f0, 0xf8b0, 0xf870, 0xf830,
        0xf7f0, 0xf7b8, 0xf778, 0xf738, 0xf6f8, 0xf6b8, 0xf680, 0xf640, 0xf600, 0xf5c8, 0xf588, 0xf548, 0xf510, 0xf4d0, 0xf498, 0xf458,
        0xf420, 0xf3e0, 0xf3a8, 0xf368, 0xf330, 0xf2f8, 0xf2b8, 0xf280, 0xf248, 0xf208, 0xf1d0, 0xf198, 0xf160, 0xf128, 0xf0f0, 0xf0b8,
        0xf080, 0xf048, 0xf010, 0xefd8, 0xefa0, 0xef68, 0xef30, 0xeef8, 0xeec0, 0xee90, 0xee58, 0xee20, 0xede8, 0xedb8, 0xed80, 0xed50,
        0xed18, 0xece8, 0xecb0, 0xec80, 0xec48, 0xec18, 0xebe8, 0xebb0, 0xeb80, 0xeb50, 0xeb20, 0xeae8, 0xeab8, 0xea88, 0xea58, 0xea28,
        0xe9f8, 0xe9c8, 0xe998, 0xe968, 0xe938, 0xe908, 0xe8e0, 0xe8b0, 0xe880, 0xe850, 0xe828, 0xe7f8, 0xe7c8, 0xe7a0, 0xe770, 0xe748,
        0xe718, 0xe6f0, 0xe6c0, 0xe698, 0xe670, 0xe640, 0xe618, 0xe5f0, 0xe5c8, 0xe598, 0xe570, 0xe548, 0xe520, 0xe4f8, 0xe4d0, 0xe4a8,
        0xe480, 0xe458, 0xe430, 0xe408, 0xe3e0, 0xe3b8, 0xe398, 0xe370, 0xe348, 0xe320, 0xe300, 0xe2d8, 0xe2b0, 0xe290, 0xe268, 0xe248,
        0xe220, 0xe200, 0xe1d8, 0xe1b8, 0xe190, 0xe170, 0xe150, 0xe128, 0xe108, 0xe0e8, 0xe0c0, 0xe0a0, 0xe080, 0xe060, 0xe040, 0xe020,
        0xdff8,
};
const int16_t viewangletox[FINEANGLES / 2] = {
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140, 0x0140,
        0x0140, 0x0140, 0x0140, 0x0140, 0x013f, 0x013f, 0x013f, 0x013f, 0x013e, 0x013e, 0x013e, 0x013e, 0x013d, 0x013d, 0x013d, 0x013d,
        0x013c, 0x013c, 0x013c, 0x013c, 0x013b, 0x013b, 0x013b, 0x013b, 0x013a, 0x013a, 0x013a, 0x013a, 0x013a, 0x0139, 0x0139, 0x0139,
        0x0139, 0x0138, 0x0138, 0x0138, 0x0138, 0x0137, 0x0137, 0x0137, 0x0137, 0x0137, 0x0136, 0x0136, 0x0136, 0x0136, 0x0135, 0x0135,
        0x0135, 0x0135, 0x0134, 0x0134, 0x0134, 0x0134, 0x0134, 0x0133, 0x0133, 0x0133, 0x0133, 0x0132, 0x0132, 0x0132, 0x0132, 0x0132,
        0x0131, 0x0131, 0x0131, 0x0131, 0x0130, 0x0130, 0x0130, 0x0130, 0x0130, 0x012f, 0x012f, 0x012f, 0x012f, 0x012e, 0x012e, 0x012e,
        0x012e, 0x012e, 0x012d, 0x012d, 0x012d, 0x012d, 0x012c, 0x012c, 0x012c, 0x012c, 0x012c, 0x012b, 0x012b, 0x012b, 0x012b, 0x012b,
        0x012a, 0x012a, 0x012a, 0x012a, 0x0129, 0x0129, 0x0129, 0x0129, 0x0129, 0x0128, 0x0128, 0x0128, 0x0128, 0x0128, 0x0127, 0x0127,
        0x0127, 0x0127, 0x0127, 0x0126, 0x0126, 0x0126, 0x0126, 0x0125, 0x0125, 0x0125, 0x0125, 0x0125, 0x0124, 0x0124, 0x0124, 0x0124,
        0x0124, 0x0123, 0x0123, 0x0123, 0x0123, 0x0123, 0x0122, 0x0122, 0x0122, 0x0122, 0x0122, 0x0121, 0x0121, 0x0121, 0x0121, 0x0121,
        0x0120, 0x0120, 0x0120, 0x0120, 0x0120, 0x011f, 0x011f, 0x011f, 0x011f, 0x011f, 0x011e, 0x011e, 0x011e, 0x011e, 0x011e, 0x011d,
        0x011d, 0x011d, 0x011d, 0x011d, 0x011c, 0x011c, 0x011c, 0x011c, 0x011c, 0x011b, 0x011b, 0x011b, 0x011b, 0x011b, 0x011a, 0x011a,
        0x011a, 0x011a, 0x011a, 0x0119, 0x0119, 0x0119, 0x0119, 0x0119, 0x0119, 0x0118, 0x0118, 0x0118, 0x0118, 0x0118, 0x0117, 0x0117,
        0x0117, 0x0117, 0x0117, 0x0116, 0x0116, 0x0116, 0x0116, 0x0116, 0x0115, 0x0115, 0x0115, 0x0115, 0x0115, 0x0115, 0x0114, 0x0114,
        0x0114, 0x0114, 0x0114, 0x0113, 0x0113, 0x0113, 0x0113, 0x0113, 0x0112, 0x0112, 0x0112, 0x0112, 0x0112, 0x0112, 0x0111, 0x0111,
        0x0111, 0x0111, 0x0111, 0x0110, 0x0110, 0x0110, 0x0110, 0x0110, 0x0110, 0x010f, 0x010f, 0x010f, 0x010f, 0x010f, 0x010e, 0x010e,
        0x010e, 0x010e, 0x010e, 0x010e, 0x010d, 0x010d, 0x010d, 0x010d, 0x010d, 0x010c, 0x010c, 0x010c, 0x010c, 0x010c, 0x010c, 0x010b,
        0x010b, 0x010b, 0x010b, 0x010b, 0x010b, 0x010a, 0x010a, 0x010a, 0x010a, 0x010a, 0x0109, 0x0109, 0x0109, 0x0109, 0x0109, 0x0109,
        0x0108, 0x0108, 0x0108, 0x0108, 0x0108, 0x0108, 0x0107, 0x0107, 0x0107, 0x0107, 0x0107, 0x0107, 0x0106, 0x0106, 0x0106, 0x0106,
        0x0106, 0x0105, 0x0105, 0x0105, 0x0105, 0x0105, 0x0105, 0x0104, 0x0104, 0x0104, 0x0104, 0x0104, 0x0104, 0x0103, 0x0103, 0x0103,
        0x0103, 0x0103, 0x0103, 0x0102, 0x0102, 0x0102, 0x0102, 0x0102, 0x0102, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0101, 0x0100,
        0x0100, 0x0100, 0x0100, 0x0100, 0x0100, 0x00ff, 0x00ff, 0x00ff, 0x00ff, 0x00ff, 0x00ff, 0x00fe, 0x00fe, 0x00fe, 0x00fe, 0x00fe,
        0x00fe, 0x00fd, 0x00fd, 0x00fd, 0x00fd, 0x00fd, 0x00fd, 0x00fc, 0x00fc, 0x00fc, 0x00fc, 0x00fc, 0x00fc, 0x00fb, 0x00fb, 0x00fb,
        0x00fb, 0x00fb, 0x00fb, 0x00fb, 0x00fa, 0x00fa, 0x00fa, 0x00fa, 0x00fa, 0x00fa, 0x00f9, 0x00f9, 0x00f9, 0x00f9, 0x00f9, 0x00f9,
        0x00f8, 0x00f8, 0x00f8, 0x00f8, 0x00f8, 0x00f8, 0x00f7, 0x00f7, 0x00f7, 0x00f7, 0x00f7, 0x00f7, 0x00f7, 0x00f6, 0x00f6, 0x00f6,
        0x00f6, 0x00f6, 0x00f6, 0x00f5, 0x00f5, 0x00f5, 0x00f5, 0x00f5, 0x00f5, 0x00f4, 0x00f4, 0x00f4, 0x00f4, 0x00f4, 0x00f4, 0x00f4,
        0x00f3, 0x00f3, 0x00f3, 0x00f3, 0x00f3, 0x00f3, 0x00f2, 0x00f2, 0x00f2, 0x00f2, 0x00f2, 0x00f2, 0x00f2, 0x00f1, 0x00f1, 0x00f1,
        0x00f1, 0x00f1, 0x00f1, 0x00f0, 0x00f0, 0x00f0, 0x00f0, 0x00f0, 0x00f0, 0x00f0, 0x00ef, 0x00ef, 0x00ef, 0x00ef, 0x00ef, 0x00ef,
        0x00ee, 0x00ee, 0x00ee, 0x00ee, 0x00ee, 0x00ee, 0x00ee, 0x00ed, 0x00ed, 0x00ed, 0x00ed, 0x00ed, 0x00ed, 0x00ec, 0x00ec, 0x00ec,
        0x00ec, 0x00ec, 0x00ec, 0x00ec, 0x00eb, 0x00eb, 0x00eb, 0x00eb, 0x00eb, 0x00eb, 0x00eb, 0x00ea, 0x00ea, 0x00ea, 0x00ea, 0x00ea,
        0x00ea, 0x00ea, 0x00e9, 0x00e9, 0x00e9, 0x00e9, 0x00e9, 0x00e9, 0x00e8, 0x00e8, 0x00e8, 0x00e8, 0x00e8, 0x00e8, 0x00e8, 0x00e7,
        0x00e7, 0x00e7, 0x00e7, 0x00e7, 0x00e7, 0x00e7, 0x00e6, 0x00e6, 0x00e6, 0x00e6, 0x00e6, 0x00e6, 0x00e6, 0x00e5, 0x00e5, 0x00e5,
        0x00e5, 0x00e5, 0x00e5, 0x00e5, 0x00e4, 0x00e4, 0x00e4, 0x00e4, 0x00e4, 0x00e4, 0x00e4, 0x00e3, 0x00e3, 0x00e3, 0x00e3, 0x00e3,
        0x00e3, 0x00e3, 0x00e2, 0x00e2, 0x00e2, 0x00e2, 0x00e2, 0x00e2, 0x00e2, 0x00e1, 0x00e1, 0x00e1, 0x00e1, 0x00e1, 0x00e1, 0x00e1,
        0x00e0, 0x00e0, 0x00e0, 0x00e0, 0x00e0, 0x00e0, 0x00e0, 0x00df, 0x00df, 0x00df, 0x00df, 0x00df, 0x00df, 0x00df, 0x00de, 0x00de,
        0x00de, 0x00de, 0x00de, 0x00de, 0x00de, 0x00dd, 0x00dd, 0x00dd, 0x00dd, 0x00dd, 0x00dd, 0x00dd, 0x00dc, 0x00dc, 0x00dc, 0x00dc,
        0x00dc, 0x00dc, 0x00dc, 0x00db, 0x00db, 0x00db, 0x00db, 0x00db, 0x00db, 0x00db, 0x00da, 0x00da, 0x00da, 0x00da, 0x00da, 0x00da,
        0x00da, 0x00d9, 0x00d9, 0x00d9, 0x00d9, 0x00d9, 0x00d9, 0x00d9, 0x00d9, 0x00d8, 0x00d8, 0x00d8, 0x00d8, 0x00d8, 0x00d8, 0x00d8,
        0x00d7, 0x00d7, 0x00d7, 0x00d7, 0x00d7, 0x00d7, 0x00d7, 0x00d6, 0x00d6, 0x00d6, 0x00d6, 0x00d6, 0x00d6, 0x00d6, 0x00d6, 0x00d5,
        0x00d5, 0x00d5, 0x00d5, 0x00d5, 0x00d5, 0x00d5, 0x00d4, 0x00d4, 0x00d4, 0x00d4, 0x00d4, 0x00d4, 0x00d4, 0x00d3, 0x00d3, 0x00d3,
        0x00d3, 0x00d3, 0x00d3, 0x00d3, 0x00d3, 0x00d2, 0x00d2, 0x00d2, 0x00d2, 0x00d2, 0x00d2, 0x00d2, 0x00d1, 0x00d1, 0x00d1, 0x00d1,
        0x00d1, 0x00d1, 0x00d1, 0x00d1, 0x00d0, 0x00d0, 0x00d0, 0x00d0, 0x00d0, 0x00d0, 0x00d0, 0x00cf, 0x00cf, 0x00cf, 0x00cf, 0x00cf,
        0x00cf, 0x00cf, 0x00cf, 0x00ce, 0x00ce, 0x00ce, 0x00ce, 0x00ce, 0x00ce, 0x00ce, 0x00cd, 0x00cd, 0x00cd, 0x00cd, 0x00cd, 0x00cd,
        0x00cd, 0x00cd, 0x00cc, 0x00cc, 0x00cc, 0x00cc, 0x00cc, 0x00cc, 0x00cc, 0x00cb, 0x00cb, 0x00cb, 0x00cb, 0x00cb, 0x00cb, 0x00cb,
        0x00cb, 0x00ca, 0x00ca, 0x00ca, 0x00ca, 0x00ca, 0x00ca, 0x00ca, 0x00ca, 0x00c9, 0x00c9, 0x00c9, 0x00c9, 0x00c9, 0x00c9, 0x00c9,
        0x00c8, 0x00c8, 0x00c8, 0x00c8, 0x00c8, 0x00c8, 0x00c8, 0x00c8, 0x00c7, 0x00c7, 0x00c7, 0x00c7, 0x00c7, 0x00c7, 0x00c7, 0x00c7,
        0x00c6, 0x00c6, 0x00c6, 0x00c6, 0x00c6, 0x00c6, 0x00c6, 0x00c5, 0x00c5, 0x00c5, 0x00c5, 0x00c5, 0x00c5, 0x00c5, 0x00c5, 0x00c4,
        0x00c4, 0x00c4, 0x00c4, 0x00c4, 0x00c4, 0x00c4, 0x00c4, 0x00c3, 0x00c3, 0x00c3, 0x00c3, 0x00c3, 0x00c3, 0x00c3, 0x00c3, 0x00c2,
        0x00c2, 0x00c2, 0x00c2, 0x00c2, 0x00c2, 0x00c2, 0x00c2, 0x00c1, 0x00c1, 0x00c1, 0x00c1, 0x00c1, 0x00c1, 0x00c1, 0x00c0, 0x00c0,
        0x00c0, 0x00c0, 0x00c0, 0x00c0, 0x00c0, 0x00c0, 0x00bf, 0x00bf, 0x00bf, 0x00bf, 0x00bf, 0x00bf, 0x00bf, 0x00bf, 0x00be, 0x00be,
        0x00be, 0x00be, 0x00be, 0x00be, 0x00be, 0x00be, 0x00bd, 0x00bd, 0x00bd, 0x00bd, 0x00bd, 0x00bd, 0x00bd, 0x00bd, 0x00bc, 0x00bc,
        0x00bc, 0x00bc, 0x00bc, 0x00bc, 0x00bc, 0x00bc, 0x00bb, 0x00bb, 0x00bb, 0x00bb, 0x00bb, 0x00bb, 0x00bb, 0x00bb, 0x00ba, 0x00ba,
        0x00ba, 0x00ba, 0x00ba, 0x00ba, 0x00ba, 0x00ba, 0x00b9, 0x00b9, 0x00b9, 0x00b9, 0x00b9, 0x00b9, 0x00b9, 0x00b9, 0x00b8, 0x00b8,
        0x00b8, 0x00b8, 0x00b8, 0x00b8, 0x00b8, 0x00b8, 0x00b7, 0x00b7, 0x00b7, 0x00b7, 0x00b7, 0x00b7, 0x00b7, 0x00b7, 0x00b6, 0x00b6,
        0x00b6, 0x00b6, 0x00b6, 0x00b6, 0x00b6, 0x00b6, 0x00b5, 0x00b5, 0x00b5, 0x00b5, 0x00b5, 0x00b5, 0x00b5, 0x00b5, 0x00b4, 0x00b4,
        0x00b4, 0x00b4, 0x00b4, 0x00b4, 0x00b4, 0x00b4, 0x00b3, 0x00b3, 0x00b3, 0x00b3, 0x00b3, 0x00b3, 0x00b3, 0x00b3, 0x00b2, 0x00b2,
        0x00b2, 0x00b2, 0x00b2, 0x00b2, 0x00b2, 0x00b2, 0x00b1, 0x00b1, 0x00b1, 0x00b1, 0x00b1, 0x00b1, 0x00b1, 0x00b1, 0x00b0, 0x00b0,
        0x00b0, 0x00b0, 0x00b0, 0x00b0, 0x00b0, 0x00b0, 0x00af, 0x00af, 0x00af, 0x00af, 0x00af, 0x00af, 0x00af, 0x00af, 0x00ae, 0x00ae,
        0x00ae, 0x00ae, 0x00ae, 0x00ae, 0x00ae, 0x00ae, 0x00ad, 0x00ad, 0x00ad, 0x00ad, 0x00ad, 0x00ad, 0x00ad, 0x00ad, 0x00ac, 0x00ac,
        0x00ac, 0x00ac, 0x00ac, 0x00ac, 0x00ac, 0x00ac, 0x00ab, 0x00ab, 0x00ab, 0x00ab, 0x00ab, 0x00ab, 0x00ab, 0x00ab, 0x00ab, 0x00aa,
        0x00aa, 0x00aa, 0x00aa, 0x00aa, 0x00aa, 0x00aa, 0x00aa, 0x00a9, 0x00a9, 0x00a9, 0x00a9, 0x00a9, 0x00a9, 0x00a9, 0x00a9, 0x00a8,
        0x00a8, 0x00a8, 0x00a8, 0x00a8, 0x00a8, 0x00a8, 0x00a8, 0x00a7, 0x00a7, 0x00a7, 0x00a7, 0x00a7, 0x00a7, 0x00a7, 0x00a7, 0x00a6,
        0x00a6, 0x00a6, 0x00a6, 0x00a6, 0x00a6, 0x00a6, 0x00a6, 0x00a5, 0x00a5, 0x00a5, 0x00a5, 0x00a5, 0x00a5, 0x00a5, 0x00a5, 0x00a4,
        0x00a4, 0x00a4, 0x00a4, 0x00a4, 0x00a4, 0x00a4, 0x00a4, 0x00a4, 0x00a3, 0x00a3, 0x00a3, 0x00a3, 0x00a3, 0x00a3, 0x00a3, 0x00a3,
        0x00a2, 0x00a2, 0x00a2, 0x00a2, 0x00a2, 0x00a2, 0x00a2, 0x00a2, 0x00a1, 0x00a1, 0x00a1, 0x00a1, 0x00a1, 0x00a1, 0x00a1, 0x00a1,
        0x00a0, 0x00a0, 0x00a0, 0x00a0, 0x00a0, 0x00a0, 0x00a0, 0x00a0, 0x009f, 0x009f, 0x009f, 0x009f, 0x009f, 0x009f, 0x009f, 0x009f,
        0x009e, 0x009e, 0x009e, 0x009e, 0x009e, 0x009e, 0x009e, 0x009e, 0x009d, 0x009d, 0x009d, 0x009d, 0x009d, 0x009d, 0x009d, 0x009d,
        0x009d, 0x009c, 0x009c, 0x009c, 0x009c, 0x009c, 0x009c, 0x009c, 0x009c, 0x009b, 0x009b, 0x009b, 0x009b, 0x009b, 0x009b, 0x009b,
        0x009b, 0x009a, 0x009a, 0x009a, 0x009a, 0x009a, 0x009a, 0x009a, 0x009a, 0x0099, 0x0099, 0x0099, 0x0099, 0x0099, 0x0099, 0x0099,
        0x0099, 0x0098, 0x0098, 0x0098, 0x0098, 0x0098, 0x0098, 0x0098, 0x0098, 0x0097, 0x0097, 0x0097, 0x0097, 0x0097, 0x0097, 0x0097,
        0x0097, 0x0096, 0x0096, 0x0096, 0x0096, 0x0096, 0x0096, 0x0096, 0x0096, 0x0096, 0x0095, 0x0095, 0x0095, 0x0095, 0x0095, 0x0095,
        0x0095, 0x0095, 0x0094, 0x0094, 0x0094, 0x0094, 0x0094, 0x0094, 0x0094, 0x0094, 0x0093, 0x0093, 0x0093, 0x0093, 0x0093, 0x0093,
        0x0093, 0x0093, 0x0092, 0x0092, 0x0092, 0x0092, 0x0092, 0x0092, 0x0092, 0x0092, 0x0091, 0x0091, 0x0091, 0x0091, 0x0091, 0x0091,
        0x0091, 0x0091, 0x0090, 0x0090, 0x0090, 0x0090, 0x0090, 0x0090, 0x0090, 0x0090, 0x008f, 0x008f, 0x008f, 0x008f, 0x008f, 0x008f,
        0x008f, 0x008f, 0x008e, 0x008e, 0x008e, 0x008e, 0x008e, 0x008e, 0x008e, 0x008e, 0x008d, 0x008d, 0x008d, 0x008d, 0x008d, 0x008d,
        0x008d, 0x008d, 0x008c, 0x008c, 0x008c, 0x008c, 0x008c, 0x008c, 0x008c, 0x008c, 0x008b, 0x008b, 0x008b, 0x008b, 0x008b, 0x008b,
        0x008b, 0x008b, 0x008a, 0x008a, 0x008a, 0x008a, 0x008a, 0x008a, 0x008a, 0x008a, 0x0089, 0x0089, 0x0089, 0x0089, 0x0089, 0x0089,
        0x0089, 0x0089, 0x0088, 0x0088, 0x0088, 0x0088, 0x0088, 0x0088, 0x0088, 0x0088, 0x0087, 0x0087, 0x0087, 0x0087, 0x0087, 0x0087,
        0x0087, 0x0087, 0x0086, 0x0086, 0x0086, 0x0086, 0x0086, 0x0086, 0x0086, 0x0086, 0x0085, 0x0085, 0x0085, 0x0085, 0x0085, 0x0085,
        0x0085, 0x0085, 0x0084, 0x0084, 0x0084, 0x0084, 0x0084, 0x0084, 0x0084, 0x0084, 0x0083, 0x0083, 0x0083, 0x0083, 0x0083, 0x0083,
        0x0083, 0x0083, 0x0082, 0x0082, 0x0082, 0x0082, 0x0082, 0x0082, 0x0082, 0x0082, 0x0081, 0x0081, 0x0081, 0x0081, 0x0081, 0x0081,
        0x0081, 0x0081, 0x0080, 0x0080, 0x0080, 0x0080, 0x0080, 0x0080, 0x0080, 0x007f, 0x007f, 0x007f, 0x007f, 0x007f, 0x007f, 0x007f,
        0x007f, 0x007e, 0x007e, 0x007e, 0x007e, 0x007e, 0x007e, 0x007e, 0x007e, 0x007d, 0x007d, 0x007d, 0x007d, 0x007d, 0x007d, 0x007d,
        0x007d, 0x007c, 0x007c, 0x007c, 0x007c, 0x007c, 0x007c, 0x007c, 0x007c, 0x007b, 0x007b, 0x007b, 0x007b, 0x007b, 0x007b, 0x007b,
        0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x007a, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079, 0x0079,
        0x0078, 0x0078, 0x0078, 0x0078, 0x0078, 0x0078, 0x0078, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0077, 0x0076,
        0x0076, 0x0076, 0x0076, 0x0076, 0x0076, 0x0076, 0x0076, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0075, 0x0074, 0x0074,
        0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 0x0074, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0073, 0x0072, 0x0072, 0x0072,
        0x0072, 0x0072, 0x0072, 0x0072, 0x0072, 0x0071, 0x0071, 0x0071, 0x0071, 0x0071, 0x0071, 0x0071, 0x0070, 0x0070, 0x0070, 0x0070,
        0x0070, 0x0070, 0x0070, 0x0070, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006f, 0x006e, 0x006e, 0x006e, 0x006e, 0x006e,
        0x006e, 0x006e, 0x006e, 0x006d, 0x006d, 0x006d, 0x006d, 0x006d, 0x006d, 0x006d, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c, 0x006c,
        0x006c, 0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006b, 0x006a, 0x006a, 0x006a, 0x006a, 0x006a, 0x006a, 0x006a,
        0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0069, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0068, 0x0067,
        0x0067, 0x0067, 0x0067, 0x0067, 0x0067, 0x0067, 0x0066, 0x0066, 0x0066, 0x0066, 0x0066, 0x0066, 0x0066, 0x0065, 0x0065, 0x0065,
        0x0065, 0x0065, 0x0065, 0x0065, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 0x0064, 0x0063, 0x0063, 0x0063, 0x0063, 0x0063,
        0x0063, 0x0063, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062, 0x0062, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061, 0x0061,
        0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x0060, 0x005f, 0x005f, 0x005f, 0x005f, 0x005f, 0x005f, 0x005f, 0x005e, 0x005e,
        0x005e, 0x005e, 0x005e, 0x005e, 0x005e, 0x005d, 0x005d, 0x005d, 0x005d, 0x005d, 0x005d, 0x005d, 0x005c, 0x005c, 0x005c, 0x005c,
        0x005c, 0x005c, 0x005c, 0x005b, 0x005b, 0x005b, 0x005b, 0x005b, 0x005b, 0x005b, 0x005a, 0x005a, 0x005a, 0x005a, 0x005a, 0x005a,
        0x005a, 0x0059, 0x0059, 0x0059, 0x0059, 0x0059, 0x0059, 0x0059, 0x0058, 0x0058, 0x0058, 0x0058, 0x0058, 0x0058, 0x0057, 0x0057,
        0x0057, 0x0057, 0x0057, 0x0057, 0x0057, 0x0056, 0x0056, 0x0056, 0x0056, 0x0056, 0x0056, 0x0056, 0x0055, 0x0055, 0x0055, 0x0055,
        0x0055, 0x0055, 0x0055, 0x0054, 0x0054, 0x0054, 0x0054, 0x0054, 0x0054, 0x0053, 0x0053, 0x0053, 0x0053, 0x0053, 0x0053, 0x0053,
        0x0052, 0x0052, 0x0052, 0x0052, 0x0052, 0x0052, 0x0051, 0x0051, 0x0051, 0x0051, 0x0051, 0x0051, 0x0051, 0x0050, 0x0050, 0x0050,
        0x0050, 0x0050, 0x0050, 0x004f, 0x004f, 0x004f, 0x004f, 0x004f, 0x004f, 0x004f, 0x004e, 0x004e, 0x004e, 0x004e, 0x004e, 0x004e,
        0x004d, 0x004d, 0x004d, 0x004d, 0x004d, 0x004d, 0x004d, 0x004c, 0x004c, 0x004c, 0x004c, 0x004c, 0x004c, 0x004b, 0x004b, 0x004b,
        0x004b, 0x004b, 0x004b, 0x004a, 0x004a, 0x004a, 0x004a, 0x004a, 0x004a, 0x004a, 0x0049, 0x0049, 0x0049, 0x0049, 0x0049, 0x0049,
        0x0048, 0x0048, 0x0048, 0x0048, 0x0048, 0x0048, 0x0047, 0x0047, 0x0047, 0x0047, 0x0047, 0x0047, 0x0046, 0x0046, 0x0046, 0x0046,
        0x0046, 0x0046, 0x0046, 0x0045, 0x0045, 0x0045, 0x0045, 0x0045, 0x0045, 0x0044, 0x0044, 0x0044, 0x0044, 0x0044, 0x0044, 0x0043,
        0x0043, 0x0043, 0x0043, 0x0043, 0x0043, 0x0042, 0x0042, 0x0042, 0x0042, 0x0042, 0x0042, 0x0041, 0x0041, 0x0041, 0x0041, 0x0041,
        0x0041, 0x0040, 0x0040, 0x0040, 0x0040, 0x0040, 0x0040, 0x003f, 0x003f, 0x003f, 0x003f, 0x003f, 0x003f, 0x003e, 0x003e, 0x003e,
        0x003e, 0x003e, 0x003e, 0x003d, 0x003d, 0x003d, 0x003d, 0x003d, 0x003d, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003c, 0x003b,
        0x003b, 0x003b, 0x003b, 0x003b, 0x003a, 0x003a, 0x003a, 0x003a, 0x003a, 0x003a, 0x0039, 0x0039, 0x0039, 0x0039, 0x0039, 0x0039,
        0x0038, 0x0038, 0x0038, 0x0038, 0x0038, 0x0038, 0x0037, 0x0037, 0x0037, 0x0037, 0x0037, 0x0036, 0x0036, 0x0036, 0x0036, 0x0036,
        0x0036, 0x0035, 0x0035, 0x0035, 0x0035, 0x0035, 0x0035, 0x0034, 0x0034, 0x0034, 0x0034, 0x0034, 0x0033, 0x0033, 0x0033, 0x0033,
        0x0033, 0x0033, 0x0032, 0x0032, 0x0032, 0x0032, 0x0032, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0031, 0x0030, 0x0030, 0x0030,
        0x0030, 0x0030, 0x002f, 0x002f, 0x002f, 0x002f, 0x002f, 0x002f, 0x002e, 0x002e, 0x002e, 0x002e, 0x002e, 0x002d, 0x002d, 0x002d,
        0x002d, 0x002d, 0x002c, 0x002c, 0x002c, 0x002c, 0x002c, 0x002c, 0x002b, 0x002b, 0x002b, 0x002b, 0x002b, 0x002a, 0x002a, 0x002a,
        0x002a, 0x002a, 0x0029, 0x0029, 0x0029, 0x0029, 0x0029, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0028, 0x0027, 0x0027, 0x0027,
        0x0027, 0x0027, 0x0026, 0x0026, 0x0026, 0x0026, 0x0026, 0x0025, 0x0025, 0x0025, 0x0025, 0x0025, 0x0024, 0x0024, 0x0024, 0x0024,
        0x0024, 0x0023, 0x0023, 0x0023, 0x0023, 0x0023, 0x0022, 0x0022, 0x0022, 0x0022, 0x0022, 0x0021, 0x0021, 0x0021, 0x0021, 0x0021,
        0x0020, 0x0020, 0x0020, 0x0020, 0x0020, 0x001f, 0x001f, 0x001f, 0x001f, 0x001f, 0x001e, 0x001e, 0x001e, 0x001e, 0x001e, 0x001d,
        0x001d, 0x001d, 0x001d, 0x001d, 0x001c, 0x001c, 0x001c, 0x001c, 0x001c, 0x001b, 0x001b, 0x001b, 0x001b, 0x001a, 0x001a, 0x001a,
        0x001a, 0x001a, 0x0019, 0x0019, 0x0019, 0x0019, 0x0019, 0x0018, 0x0018, 0x0018, 0x0018, 0x0018, 0x0017, 0x0017, 0x0017, 0x0017,
        0x0016, 0x0016, 0x0016, 0x0016, 0x0016, 0x0015, 0x0015, 0x0015, 0x0015, 0x0015, 0x0014, 0x0014, 0x0014, 0x0014, 0x0013, 0x0013,
        0x0013, 0x0013, 0x0013, 0x0012, 0x0012, 0x0012, 0x0012, 0x0011, 0x0011, 0x0011, 0x0011, 0x0011, 0x0010, 0x0010, 0x0010, 0x0010,
        0x000f, 0x000f, 0x000f, 0x000f, 0x000f, 0x000e, 0x000e, 0x000e, 0x000e, 0x000d, 0x000d, 0x000d, 0x000d, 0x000d, 0x000c, 0x000c,
        0x000c, 0x000c, 0x000b, 0x000b, 0x000b, 0x000b, 0x000a, 0x000a, 0x000a, 0x000a, 0x000a, 0x0009, 0x0009, 0x0009, 0x0009, 0x0008,
        0x0008, 0x0008, 0x0008, 0x0007, 0x0007, 0x0007, 0x0007, 0x0007, 0x0006, 0x0006, 0x0006, 0x0006, 0x0005, 0x0005, 0x0005, 0x0005,
        0x0004, 0x0004, 0x0004, 0x0004, 0x0003, 0x0003, 0x0003, 0x0003, 0x0002, 0x0002, 0x0002, 0x0002, 0x0001, 0x0001, 0x0001, 0x0001,
        0x0001, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,
        0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,

};
#endif

#if !USE_LIGHTMAP_INDEXES
const lighttable_t*		scalelight[LIGHTLEVELS][MAXLIGHTSCALE];
const lighttable_t*		scalelightfixed[MAXLIGHTSCALE];
#if !NO_USE_ZLIGHT
const lighttable_t*		zlight[LIGHTLEVELS][MAXLIGHTZ];
#endif
#else
int8_t scalelight[LIGHTLEVELS][MAXLIGHTSCALE];
int8_t scalelightfixed[MAXLIGHTSCALE];
#if !NO_USE_ZLIGHT
int8_t zlight[LIGHTLEVELS][MAXLIGHTZ];
#endif
#endif

// bumped light from gun blasts
int extralight;

#if !NO_RDRAW
void (*colfunc)(void);
void (*basecolfunc)(void);
void (*fuzzcolfunc)(void);
void (*transcolfunc)(void);
void (*spanfunc)(void);
#endif

//
// R_AddPointToBox
// Expand a given bbox
// so that it encloses a given point.
//
void
R_AddPointToBox
        (int x,
         int y,
         fixed_t *box) {
    if (x < box[BOXLEFT])
        box[BOXLEFT] = x;
    if (x > box[BOXRIGHT])
        box[BOXRIGHT] = x;
    if (y < box[BOXBOTTOM])
        box[BOXBOTTOM] = y;
    if (y > box[BOXTOP])
        box[BOXTOP] = y;
}


//
// R_PointOnSide
// Traverse BSP (sub) tree,
//  check point against partition plane.
// Returns side 0 (front) or 1 (back).
//
int
R_PointOnSide
        (fixed_t x,
         fixed_t y,
         node_t *node) {
    fixed_t dx;
    fixed_t dy;
    fixed_t left;
    fixed_t right;

    if (!node->dx) {
        if (x <= node_coord_to_fixed(node->x))
            return node->dy > 0;

        return node->dy < 0;
    }
    if (!node->dy) {
        if (y <= node_coord_to_fixed(node->y))
            return node->dx < 0;

        return node->dx > 0;
    }

    dx = (x - node_coord_to_fixed(node->x));
    dy = (y - node_coord_to_fixed(node->y));

    // todo graham, check code here.. we might be able to do better
    // Try to quickly decide by looking at sign bits.
    if ((node_coord_to_fixed(node->dy) ^ node_coord_to_fixed(node->dx) ^ dx ^ dy) & 0x80000000) {
        if ((node_coord_to_fixed(node->dy) ^ dx) & 0x80000000) {
            // (left is negative)
            return 1;
        }
        return 0;
    }

    left = FixedMul(node_coord_to_int16(node->dy), dx);
    right = FixedMul(dy, node_coord_to_int16(node->dx));

    if (right < left) {
        // front side
        return 0;
    }
    // back side
    return 1;
}


int
R_PointOnSegSide
        (fixed_t x,
         fixed_t y,
         seg_t *line) {
    fixed_t lx;
    fixed_t ly;
    fixed_t ldx;
    fixed_t ldy;
    fixed_t dx;
    fixed_t dy;
    fixed_t left;
    fixed_t right;

    lx = vertex_x(seg_v1(line));
    ly = vertex_y(seg_v1(line));

    ldx = vertex_x(seg_v2(line)) - lx;
    ldy = vertex_y(seg_v2(line)) - ly;

    if (!ldx) {
        if (x <= lx)
            return ldy > 0;

        return ldy < 0;
    }
    if (!ldy) {
        if (y <= ly)
            return ldx < 0;

        return ldx > 0;
    }

    dx = (x - lx);
    dy = (y - ly);

    // Try to quickly decide by looking at sign bits.
    if ((ldy ^ ldx ^ dx ^ dy) & 0x80000000) {
        if ((ldy ^ dx) & 0x80000000) {
            // (left is negative)
            return 1;
        }
        return 0;
    }

    left = FixedMul(ldy >> FRACBITS, dx);
    right = FixedMul(dy, ldx >> FRACBITS);

    if (right < left) {
        // front side
        return 0;
    }
    // back side
    return 1;
}


//
// R_PointToAngle
// To get a global angle from cartesian coordinates,
//  the coordinates are flipped until they are in
//  the first octant of the coordinate system, then
//  the y (<=x) is scaled and divided by x to get a
//  tangent (slope) value which is looked up in the
//  tantoangle[] table.

//

// to get a global angle from cartesian coordinates, the coordinates are
// flipped until they are in the first octant of the coordinate system, then
// the y (<=x) is scaled and divided by x to get a tangent (slope) value
// which is looked up in the tantoangle[] table.  The +1 size is to handle
// the case when x==y without additional checking.

static int SlopeDiv(unsigned int num, unsigned int den)
{
    unsigned ans;

    if (den < 512)
    {
        return SLOPERANGE;
    }
    else
    {
        ans = (num << 3) / (den >> 8);

        if (ans <= SLOPERANGE)
        {
            return ans;
        }
        else
        {
            return SLOPERANGE;
        }
    }
}


angle_t
R_PointToAngleDX
        (fixed_t x,
         fixed_t y) {
    if ((!x) && (!y))
        return 0;

    if (x >= 0) {
        // x >=0
        if (y >= 0) {
            // y>= 0

            if (x > y) {
                // octant 0
                return tantoangle[SlopeDiv(y, x)];
            } else {
                // octant 1
                return ANG90 - 1 - tantoangle[SlopeDiv(x, y)];
            }
        } else {
            // y<0
            y = -y;

            if (x > y) {
                // octant 8
                return -tantoangle[SlopeDiv(y, x)];
            } else {
                // octant 7
                return ANG270 + tantoangle[SlopeDiv(x, y)];
            }
        }
    } else {
        // x<0
        x = -x;

        if (y >= 0) {
            // y>= 0
            if (x > y) {
                // octant 3
                return ANG180 - 1 - tantoangle[SlopeDiv(y, x)];
            } else {
                // octant 2
                return ANG90 + tantoangle[SlopeDiv(x, y)];
            }
        } else {
            // y<0
            y = -y;

            if (x > y) {
                // octant 4
                return ANG180 + tantoangle[SlopeDiv(y, x)];
            } else {
                // octant 5
                return ANG270 - 1 - tantoangle[SlopeDiv(x, y)];
            }
        }
    }
    return 0;
}


angle_t
R_PointToAngle2
        (fixed_t x1,
         fixed_t y1,
         fixed_t x2,
         fixed_t y2) {
    viewx = x1;
    viewy = y1;

    return R_PointToAngle(x2, y2);
}


fixed_t
R_PointToDist
        (fixed_t x,
         fixed_t y) {
    int angle;
    fixed_t dx;
    fixed_t dy;
    fixed_t temp;
    fixed_t dist;
    fixed_t frac;

    dx = abs(x - viewx);
    dy = abs(y - viewy);

    if (dy > dx) {
        temp = dx;
        dx = dy;
        dy = temp;
    }

    // Fix crashes in udm1.wad

    if (dx != 0) {
        frac = FixedDiv(dy, dx);
    } else {
        frac = 0;
    }

    angle = (tantoangle[frac >> DBITS] + ANG90) >> ANGLETOFINESHIFT;

    // use as cosine
    dist = FixedDiv(dx, finesine(angle));

    return dist;
}


//
// R_InitPointToAngle
//
void R_InitPointToAngle(void) {
    // UNUSED - now getting from tables.c
#if 0
    int	i;
    long	t;
    float	f;
//
// slope (tangent) to angle lookup
//
    for (i=0 ; i<=SLOPERANGE ; i++)
    {
    f = atan( (float)i/SLOPERANGE )/(3.141592657*2);
    t = 0xffffffff*f;
    tantoangle[i] = t;
    }
#endif
}


//
// R_ScaleFromGlobalAngle
// Returns the texture mapping scale
//  for the current line (horizontal span)
//  at the given angle.
// rw_distance must be calculated first.
//
fixed_t R_ScaleFromGlobalAngle(angle_t visangle) {
    fixed_t scale;
    angle_t anglea;
    angle_t angleb;
    int sinea;
    int sineb;
    fixed_t num;
    int den;

    // UNUSED
#if 0
    {
        fixed_t		dist;
        fixed_t		z;
        fixed_t		sinv;
        fixed_t		cosv;

        sinv = finesine((visangle-rw_normalangle)>>ANGLETOFINESHIFT);
        dist = FixedDiv (rw_distance, sinv);
        cosv = finecosine((viewangle-visangle)>>ANGLETOFINESHIFT);
        z = abs(FixedMul (dist, cosv));
        scale = FixedDiv(projection, z);
        return scale;
    }
#endif

    anglea = ANG90 + (visangle - viewangle);
    angleb = ANG90 + (visangle - rw_normalangle);

    // both sines are allways positive
    sinea = finesine(anglea >> ANGLETOFINESHIFT);
    sineb = finesine(angleb >> ANGLETOFINESHIFT);
    num = FixedMul(projection, sineb) << detailshift;
    den = FixedMul(rw_distance, sinea);

    if (den > num >> FRACBITS) {
        scale = FixedDiv(num, den);

        if (scale > 64 * FRACUNIT)
            scale = 64 * FRACUNIT;
        else if (scale < 256)
            scale = 256;
    } else
        scale = 64 * FRACUNIT;

    return scale;
}


//
// R_InitTables
//
void R_InitTables(void) {
    // UNUSED: now getting from tables.c
#if 0
    int		i;
    float	a;
    float	fv;
    int		t;
    
    // viewangle tangent table
    for (i=0 ; i<FINEANGLES/2 ; i++)
    {
    a = (i-FINEANGLES/4+0.5)*PI*2/FINEANGLES;
    fv = FRACUNIT*tan (a);
    t = fv;
    finetangent(i) = t;
    }

    // finesine table
    for (i=0 ; i<5*FINEANGLES/4 ; i++)
    {
    // OPTIMIZE: mirror...
    a = (i+0.5)*PI*2/FINEANGLES;
    t = FRACUNIT*sin (a);
    finesine(i) = t;
    }
#endif

}


//
// R_InitTextureMapping
//
void R_InitTextureMapping(void) {
#if !FIXED_SCREENWIDTH
    int i;
    int x;
    int t;
    fixed_t focallength;

    // Use tangent table to generate viewangletox:
    //  viewangletox will give the next greatest x
    //  after the view angle.
    //
    // Calc focallength
    //  so FIELDOFVIEW angles covers SCREENWIDTH.
    focallength = FixedDiv(centerxfrac,
                           finetangent(FINEANGLES / 4 + FIELDOFVIEW / 2));

    for (i = 0; i < FINEANGLES / 2; i++) {
        if (finetangent(i) > FRACUNIT * 2)
            t = -1;
        else if (finetangent(i) < -FRACUNIT * 2)
            t = viewwidth + 1;
        else {
            t = FixedMul(finetangent(i), focallength);
            t = (centerxfrac - t + FRACUNIT - 1) >> FRACBITS;

            if (t < -1)
                t = -1;
            else if (t > viewwidth + 1)
                t = viewwidth + 1;
        }
        viewangletox[i] = t;
    }
    // Scan viewangletox[] to generate xtoviewangle[]:
    //  xtoviewangle will give the smallest view angle
    //  that maps to x.	
    for (x = 0; x <= viewwidth; x++) {
        i = 0;
        while (viewangletox[i] > x)
            i++;
        xtoviewangle[x] = (i << ANGLETOFINESHIFT) - ANG90;
    }

    // Take out the fencepost cases from viewangletox.
    for (i = 0; i < FINEANGLES / 2; i++) {
        t = FixedMul(finetangent(i), focallength);
        t = centerx - t;

        if (viewangletox[i] == -1)
            viewangletox[i] = 0;
        else if (viewangletox[i] == viewwidth + 1)
            viewangletox[i] = viewwidth;
    }

#if 0
    for(int i=0;i<count_of(xtoviewangle);i+=16) {
#ifndef MIN
#define MIN(a,b) ((a)<(b)?(a):(b))
#endif

        for(int j=i;j<MIN(i+16, count_of(xtoviewangle));j++) {
            assert(!(xtoviewangle[j]&0xffff));
            printf("0x%04x, ", xtoviewangle[j]>>16);
        }
        printf("\n");
    }
#endif
#if 0
    for(int i=0;i<count_of(viewangletox);i+=16) {
        for(int j=i;j<i+16;j++) {
            printf("0x%04x, ", viewangletox[j]);
        }
        printf("\n");
    }
#endif
#endif
    clipangle = x_to_viewangle(0);
}



//
// R_InitLightTables
// Only inits the zlight table,
//  because the scalelight table changes with view size.
//
#define DISTMAP        2

void R_InitLightTables(void) {
    int i;
    int j;
    int level;
    int startmap;
    int scale;

    // Calculate the light levels to use
    //  for each level / distance combination.
#if !NO_USE_ZLIGHT
    for (i = 0; i < LIGHTLEVELS; i++) {
        startmap = ((LIGHTLEVELS - 1 - i) * 2) * NUMCOLORMAPS / LIGHTLEVELS;
        for (j = 0; j < MAXLIGHTZ; j++) {
            scale = FixedDiv((SCREENWIDTH / 2 * FRACUNIT), (j + 1) << LIGHTZSHIFT);
            scale >>= LIGHTSCALESHIFT;
            level = startmap - scale / DISTMAP;

            if (level < 0)
                level = 0;

            if (level >= NUMCOLORMAPS)
                level = NUMCOLORMAPS - 1;

#if !USE_LIGHTMAP_INDEXES
            zlight[i][j] = colormaps + level*256;
#else
            zlight[i][j] = level;
#endif
        }
    }
#endif
}


//
// R_SetViewSize
// Do not really change anything here,
//  because it might be in the middle of a refresh.
// The change will take effect next refresh.
//
boolean setsizeneeded;
#if !DOOM_TINY
int setblocks;
int setdetail;
#else
#define setblocks 10
#define setdetail 0
#endif


void
R_SetViewSize
        (int blocks,
         int detail) {
    setsizeneeded = true;
#if !DOOM_TINY
    setblocks = blocks;
    setdetail = detail;
#endif
}


//
// R_ExecuteSetViewSize
//
void R_ExecuteSetViewSize(void) {
    fixed_t cosadj;
    fixed_t dy;
    int i;
    int j;
    int level;
    int startmap;

    setsizeneeded = false;

    if (setblocks == 11) {
        scaledviewwidth = SCREENWIDTH;
        viewheight = SCREENHEIGHT;
    } else {
        scaledviewwidth = setblocks * 32;
        viewheight = (setblocks * 168 / 10) & ~7;
    }

    detailshift = setdetail;
    viewwidth = scaledviewwidth >> detailshift;

    centery = viewheight / 2;
    centerx = viewwidth / 2;
    centerxfrac = centerx << FRACBITS;
    centeryfrac = centery << FRACBITS;
    projection = centerxfrac;

#if !NO_RDRAW
    if (!detailshift) {
        colfunc = basecolfunc = R_DrawColumn;
        fuzzcolfunc = R_DrawFuzzColumn;
        transcolfunc = R_DrawTranslatedColumn;
        spanfunc = R_DrawSpan;
    } else {
        colfunc = basecolfunc = R_DrawColumnLow;
        fuzzcolfunc = R_DrawFuzzColumnLow;
        transcolfunc = R_DrawTranslatedColumnLow;
        spanfunc = R_DrawSpanLow;
    }
#endif

#if !NO_RDRAW
    R_InitBuffer(scaledviewwidth, viewheight);
#endif

    R_InitTextureMapping();

    // psprite scales
    pspritescale = FRACUNIT * viewwidth / SCREENWIDTH;
    pspriteiscale = FRACUNIT * SCREENWIDTH / viewwidth;

    // thing clipping
    for (i = 0; i < viewwidth; i++)
        maxfloorceilingcliparray[i] = viewheight + FLOOR_CEILING_CLIP_OFFSET;

    // planes
    for (i = 0; i < viewheight; i++) {
        dy = ((i - viewheight / 2) << FRACBITS) + FRACUNIT / 2;
        dy = abs(dy);
        yslope[i] = FixedDiv((viewwidth << detailshift) / 2 * FRACUNIT, dy);
    }

#if !FIXED_SCREENWIDTH
    for (i = 0; i < viewwidth; i++) {
        cosadj = abs(finecosine(xtoviewangle[i] >> ANGLETOFINESHIFT));
        _distscale[i] = FixedDiv(FRACUNIT, cosadj);
    }
#endif

    // Calculate the light levels to use
    //  for each level / scale combination.
    for (i = 0; i < LIGHTLEVELS; i++) {
        startmap = ((LIGHTLEVELS - 1 - i) * 2) * NUMCOLORMAPS / LIGHTLEVELS;
        for (j = 0; j < MAXLIGHTSCALE; j++) {
            level = startmap - j * SCREENWIDTH / (viewwidth << detailshift) / DISTMAP;

            if (level < 0)
                level = 0;

            if (level >= NUMCOLORMAPS)
                level = NUMCOLORMAPS - 1;


#if !USE_LIGHTMAP_INDEXES
            scalelight[i][j] = colormaps + level*256;
#else
            scalelight[i][j] = level;
#endif

        }
    }
}



//
// R_Init
//



void R_Init(void) {
    R_InitData();
    printf(".");
    R_InitPointToAngle();
    printf(".");
    R_InitTables();
    // viewwidth / viewheight / detailLevel are set by the defaults
    printf(".");

    R_SetViewSize(screenblocks, detailLevel);
    R_InitPlanes();
    printf(".");
    R_InitLightTables();
    printf(".");
    R_InitSkyMap();
    R_InitTranslationTables();
    printf(".");

    framecount = 0;
}


//
// R_PointInSubsector
//
subsector_t *
R_PointInSubsector
        (fixed_t x,
         fixed_t y) {
    node_t *node;
    int side;
    int nodenum;

    // single subsector is a special case
    if (!numnodes)
        return subsectors;

    nodenum = numnodes - 1;

    while (!(nodenum & NF_SUBSECTOR)) {
        node = &nodes[nodenum];
        side = R_PointOnSide(x, y, node);
        nodenum = bsp_child(nodenum, side);
    }

    return &subsectors[nodenum & ~NF_SUBSECTOR];
}


//
// R_SetupFrame
//
void R_SetupFrame(player_t *player) {
    int i;

    viewplayer = player;
    viewx = player->mo->xy.x;
    viewy = player->mo->xy.y;
    viewangle = mobj_full(player->mo)->angle + viewangleoffset;
    extralight = player->extralight;

    viewz = player->viewz;

    viewsin = finesine(viewangle >> ANGLETOFINESHIFT);
    viewcos = finecosine(viewangle >> ANGLETOFINESHIFT);

//    sscount = 0;

    if (player->fixedcolormap) {
#if !USE_LIGHTMAP_INDEXES
        fixedcolormap =
            colormaps
            + player->fixedcolormap*256;
#else
        fixedcolormap = player->fixedcolormap;
#endif

        walllights = scalelightfixed;

        for (i = 0; i < MAXLIGHTSCALE; i++)
            scalelightfixed[i] = fixedcolormap;
    } else
        fixedcolormap = 0;

    framecount++;
    validcount++;
}

//
// R_RenderView
//
void R_RenderPlayerView(player_t *player) {
    R_SetupFrame(player);

#if MU_STATS
    stats_dc_iscale_min = 0xffffffff;
    stats_dc_iscale_max = 0;
#endif

#if USE_ERASE_FRAME
#if !NO_RDRAW
    R_VideoClear();
#endif
#endif
    // Clear buffers.
    R_ClearClipSegs();
    R_ClearDrawSegs();
    R_ClearPlanes();
    R_ClearSprites();

    // check for new console commands.
    NetUpdate();

#if PICO_ON_DEVICE
//    gpio_put(22, 1);
#endif
#if DOOM_SMALL
    sector_check_reset();
#endif
    // The head node is the last node output.
#if !USE_WHD
    R_RenderBSPNode(numnodes - 1);
#else
#if PICODOOM_RENDER_NEWHOPE
    // for pd column lets draw these early since they clip other stuff (and we don't want to discard
    // them if we run out of column slots)
    // draw the psprites on top of everything
    //  but does not draw on side views
    if (!viewangleoffset) {
        extern void R_DrawPlayerSprites(void);
        R_DrawPlayerSprites();
    }
#endif

    node_coord_t bbox[4] = { 32767, -32768, -32768, 32767 };
    R_RenderBSPNode(numnodes -1, bbox);
#endif
#if PICO_ON_DEVICE
//    gpio_put(22, 0);
#endif

    // Check for new console commands.
    NetUpdate();

#if !NO_VISPLANE_GUTS
    // Visplanes
    R_DrawPlanes();
#endif

    // Check for new console commands.
    NetUpdate();

    R_DrawMasked();

    // Check for new console commands.
    NetUpdate();
#if MU_STATS
    static uint32_t iscaler_min = 0xffffffff;
    static uint32_t iscaler_max = 0x00000000;
    if (stats_dc_iscale_min < iscaler_min) {
        iscaler_min = stats_dc_iscale_min;
        printf("< ISCALE %08x %08x\n", iscaler_min, iscaler_max);
    }
    if (stats_dc_iscale_max > iscaler_max) {
        iscaler_max = stats_dc_iscale_max;
        printf("> ISCALE %08x %08x\n", iscaler_min, iscaler_max);
    }
#endif
}

typedef unsigned int uint;
#if USE_RAW_MAPLINEDEF || DOOM_SMALL
uint32_t *line_sector_check_bitmap;
#endif
#if USE_RAW_MAPLINEDEF
uint32_t *line_mapped_bitmap, *line_special_cleared_bitmap;
void clear_line_special(should_be_const line_t *line) {
#if !WHD_SUPER_TINY
    uint index = line - lines;
    assert(index < numlines);
#else
    uint index = line_bitmap_index(line - lines);
    assert(index < numlines5);
#endif
    uint bit = 1u << (index & 31);
    line_special_cleared_bitmap[index>>5] |= bit;
}

#if SAVE_COMPRESSED
int whd_line_special(should_be_const line_t *line) {
#if !WHD_SUPER_TINY
    int rc = line->special;
    if (rc) {
        uint index = line - lines;
        assert(index < numlines);
        uint bit = 1u << (index & 31);
    }
#else
    int rc = 0;
    if ((line[1] & (ML_HAS_SPECIAL >> 8)) != 0) {
        const static uint8_t special_pos[8] = { 5, 6, 6, 7, 6, 7, 7, 8 };
        uint pos = special_pos[line[1]&7];
        rc = line[pos];
        uint index = line_bitmap_index(line - lines);
        assert(index < numlines5);
    }
#endif
    return rc;
}
#endif

int line_special(should_be_const line_t *line) {
#if !WHD_SUPER_TINY
    int rc = line->special;
    if (rc) {
        uint index = line - lines;
        assert(index < numlines);
        uint bit = 1u << (index & 31);
        if (line_special_cleared_bitmap[index>>5] & bit) {
            rc = 0;
        }
    }
#else
    int rc = 0;
    if ((line[1] & (ML_HAS_SPECIAL >> 8)) != 0) {
        const static uint8_t special_pos[8] = { 5, 6, 6, 7, 6, 7, 7, 8 };
        uint pos = special_pos[line[1]&7];
        rc = line[pos];
        uint index = line_bitmap_index(line - lines);
        assert(index < numlines5);
        uint bit = 1u << (index & 31);
        if (line_special_cleared_bitmap[index>>5] & bit) {
            rc = 0;
        }
    }
#endif
    return rc;
}

boolean line_validcount_update_check_impl(should_be_const line_t *ld) {
#if !WHD_SUPER_TINY
    uint index = ld - lines;
    assert(index < numlines);
#else
    uint index = line_bitmap_index(ld - lines);
    assert(index < numlines5);
#endif
    uint bit = 1u << (index & 31);
    index >>= 5;
    if (line_sector_check_bitmap[index] & bit) {
        return true;
    }
    line_sector_check_bitmap[index] |= bit;
    return false;
}

boolean line_is_mapped(should_be_const line_t *ld) {
#if !WHD_SUPER_TINY
    uint index = ld - lines;
    assert(index < numlines);
#else
    uint index = line_bitmap_index(ld - lines);
    assert(index < numlines5);
#endif
    uint bit = 1u << (index & 31);
    return line_mapped_bitmap[index>>5] & bit ? true : false;
}

void line_set_mapped(should_be_const line_t *ld) {
#if !WHD_SUPER_TINY
    uint index = ld - lines;
    assert(index < numlines);
#else
    uint index = line_bitmap_index(ld - lines);
    assert(index < numlines5);
#endif
    uint bit = 1u << (index & 31);
    line_mapped_bitmap[index>>5] |= bit;
}

void line_check_reset(void) {
#if !WHD_SUPER_TINY
    memset(line_sector_check_bitmap, 0, (numlines + 31) / 8);
#else
    memset(line_sector_check_bitmap, 0, (numlines5 + 31) / 8);
#endif
}
#endif
#if DOOM_SMALL
boolean sector_validcount_update_check_impl(should_be_const sector_t *s) {
    uint index = s - sectors;
    assert(index < numsectors);
    uint bit = 1u << (index & 31);
    index >>= 5;
    if (line_sector_check_bitmap[index] & bit) {
        return true;
    }
    line_sector_check_bitmap[index] |= bit;
    return false;
}

void sector_check_reset(void) {
    memset(line_sector_check_bitmap, 0, (numsectors + 31) / 8);
}
#endif

#if USE_WHD
#define MAX_SWITCHED_SIDES 32
static uint16_t switched_sides[MAX_SWITCHED_SIDES];
static uint8_t switched_sides_where[MAX_SWITCHED_SIDES];

int check_switch_texture(const side_t *side, int where, int t) {
    assert(t <= LAST_SWITCH_TEXTURE);
#if WHD_SUPER_TINY
    uint16_t off = side - sides_z;
#else
    uint16_t off = side - sides;
#endif
    for(int i=0;i<num_switched_sides;i++) {
        if (switched_sides[i] == off && switched_sides_where[i]==where) {
            return t ^ 1;
        }
    }
    return t;
}

#if SAVE_COMPRESSED
boolean is_switched_texture(const side_t *side, int where) {
#if WHD_SUPER_TINY
    uint16_t off = side - sides_z;
#else
    uint16_t off = side - sides;
#endif
    for(int i=0;i<num_switched_sides;i++) {
        if (switched_sides[i] == off && switched_sides_where[i]==where) {
            return 1;
        }
    }
    return 0;
}
#endif

static void remove_switched_side(const side_t *side, int where) {
#if WHD_SUPER_TINY
    uint16_t off = side - sides_z;
#else
    uint16_t off = side - sides;
#endif
    for(int i=0;i<num_switched_sides;i++) {
        if (switched_sides[i] == off && switched_sides_where[i] == where) {
            for(;i<num_switched_sides-1;i++) {
                switched_sides[i] = switched_sides[i+1];
                switched_sides_where[i] = switched_sides_where[i+1];
            }
            num_switched_sides--;
        }
    }
}

static void add_switched_side(const side_t *side, int where) {
#if WHD_SUPER_TINY
    uint16_t off = side - sides_z;
#else
    uint16_t off = side - sides;
#endif
    if (num_switched_sides < MAX_SWITCHED_SIDES) {
        switched_sides[num_switched_sides] = off;
        switched_sides_where[num_switched_sides++] = where;
    }
}

void side_settoptexture(const side_t *side, lumpindex_t t) {
    assert(t <= LAST_SWITCH_TEXTURE);
    int normal = side_toptexture(side);
    assert(normal == t || normal == (t ^ 1));
    if (t == normal) remove_switched_side(side, CST_TOP);
    else add_switched_side(side, CST_TOP);
}

void side_setmidtexture(const side_t *side, lumpindex_t t) {
    assert(t <= LAST_SWITCH_TEXTURE);
    int normal = side_midtexture(side);
    assert(normal == t || normal == (t ^ 1));
    if (t == normal) remove_switched_side(side, CST_MID);
    else add_switched_side(side, CST_MID);
}
void side_setbottomtexture(const side_t *side, lumpindex_t t) {
    assert(t <= LAST_SWITCH_TEXTURE);
    int normal = side_bottomtexture(side);
    assert(normal == t || normal == (t ^ 1));
    if (t == normal) remove_switched_side(side, CST_BOTTOM);
    else add_switched_side(side, CST_BOTTOM);
}

//void side_settextureoffset16(const side_t *side, int offset) {
//    linespecialoffset = offset - side_textureoffset16(side);
//}

#endif